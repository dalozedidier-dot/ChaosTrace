name: incoherence_vectorfield

"on":
  workflow_dispatch:
    inputs:
      input_csv:
        description: "CSV d'entrée"
        required: false
        default: "test_data/sample_timeseries_1_2_drops.csv"
      vars:
        description: "Variables physiques (colonnes CSV) séparées par des virgules"
        required: false
        default: "foil_height_m,boat_speed,wind_shear,wave_height"
      runs:
        description: "Nombre de runs sweep"
        required: false
        default: "3"
      seed:
        description: "Seed RNG"
        required: false
        default: "7"
      knn_k:
        description: "K voisins pour gradient local"
        required: false
        default: "25"
      max_eval_points:
        description: "Sous échantillonnage gradient (0 = full)"
        required: false
        default: "300"
      max_points_3d:
        description: "Max points affichés dans les vues 3D (subsampling uniforme)"
        required: false
        default: "8000"

      knn_links:
        description: "Liens KNN dans les vues 3D"
        required: false
        default: "true"
      knn_links_k:
        description: "KNN: k voisins"
        required: false
        default: "10"
      knn_links_max_edges:
        description: "KNN: max edges"
        required: false
        default: "22000"

      node_color:
        description: "Couleur points: cluster | dominant_var | level"
        required: false
        default: "cluster"
      edge_color:
        description: "Couleur liens: level | dominant_var | none"
        required: false
        default: "level"
      edge_filter:
        description: "Filtre liens: unstable | critical | cross | all"
        required: false
        default: "unstable"

      cluster:
        description: "Clustering sur sous-graphe instable"
        required: false
        default: "true"
      cluster_level_min:
        description: "Seuil cluster: 2=unstable, 3=critical"
        required: false
        default: "2"
      cluster_min_size:
        description: "Taille min d'un cluster"
        required: false
        default: "40"

      time_path:
        description: "Trajectoire 3D (liens temporels)"
        required: false
        default: "false"
      time_path_mode:
        description: "Trajectoire 3D: level ou single"
        required: false
        default: "level"

      export_png:
        description: "Exporter aussi des PNG Plotly (kaleido)"
        required: false
        default: "true"

      max_vectors:
        description: "Nombre max de flèches (cones) champ de vecteurs"
        required: false
        default: "900"
      sphere:
        description: "Ajouter aussi les versions unit sphere"
        required: false
        default: "true"
      sphere_surface:
        description: "Surface sphère translucide"
        required: false
        default: "true"
      show_points:
        description: "Afficher aussi les points de contexte dans le champ de vecteurs"
        required: false
        default: "true"

  push:
    paths:
      - ".github/workflows/incoherence_vectorfield.yml"
      - "scripts/viz_incoherence.py"
      - "scripts/viz_vector_field.py"

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OMP_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      PYTHONHASHSEED: "${{ inputs.seed || '7' }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install -e ".[dev]"
          pip install plotly kaleido

      - name: Run sweep
        run: |
          set -euo pipefail
          mkdir -p _ci_out/incoherence_vectorfield
          python -m chaostrace.cli.run_sweep             --input "${{ inputs.input_csv || 'test_data/sample_timeseries_1_2_drops.csv' }}"             --out _ci_out/incoherence_vectorfield             --runs "${{ inputs.runs || '3' }}"             --seed "${{ inputs.seed || '7' }}"

      - name: Build incoherence viz (clusters + liens)
        run: |
          set -euo pipefail

          INPUT_CSV="${{ inputs.input_csv || 'test_data/sample_timeseries_1_2_drops.csv' }}"
          VARS="${{ inputs.vars || 'foil_height_m,boat_speed,wind_shear,wave_height' }}"

          SPHERE_FLAGS=""
          if [ "${{ inputs.sphere || 'true' }}" = "true" ]; then SPHERE_FLAGS="$SPHERE_FLAGS --sphere"; fi
          if [ "${{ inputs.sphere_surface || 'true' }}" = "true" ]; then SPHERE_FLAGS="$SPHERE_FLAGS --sphere-surface"; fi

          TP_FLAG="--no-time-path"
          if [ "${{ inputs.time_path || 'false' }}" = "true" ]; then TP_FLAG="--time-path"; fi

          KNN_FLAG=""
          if [ "${{ inputs.knn_links || 'true' }}" = "true" ]; then
            KNN_FLAG="--knn-links --knn-links-k ${{ inputs.knn_links_k || '10' }} --knn-links-max-edges ${{ inputs.knn_links_max_edges || '22000' }}"
          fi

          CL_FLAG=""
          if [ "${{ inputs.cluster || 'true' }}" = "true" ]; then
            CL_FLAG="--cluster --cluster-level-min ${{ inputs.cluster_level_min || '2' }} --cluster-min-size ${{ inputs.cluster_min_size || '40' }}"
          fi

          PNG_FLAG=""
          if [ "${{ inputs.export_png || 'true' }}" = "true" ]; then PNG_FLAG="--export-png"; fi

          python scripts/viz_incoherence.py $SPHERE_FLAGS $TP_FLAG $KNN_FLAG $CL_FLAG $PNG_FLAG             --node-color "${{ inputs.node_color || 'cluster' }}"             --edge-color "${{ inputs.edge_color || 'level' }}"             --edge-filter "${{ inputs.edge_filter || 'unstable' }}"             --time-path-mode "${{ inputs.time_path_mode || 'level' }}"             --run-dir _ci_out/incoherence_vectorfield             --input "$INPUT_CSV"             --vars "$VARS"             --out _ci_out/incoherence_vectorfield/viz_incoherence             --knn-k "${{ inputs.knn_k || '25' }}"             --max-eval-points "${{ inputs.max_eval_points || '300' }}"             --max-points-3d "${{ inputs.max_points_3d || '8000' }}"             --copy-best

      - name: Build vector field (cones)
        run: |
          set -euo pipefail

          VF_FLAGS=""
          if [ "${{ inputs.sphere || 'true' }}" = "true" ]; then VF_FLAGS="$VF_FLAGS --sphere"; fi
          if [ "${{ inputs.sphere_surface || 'true' }}" = "true" ]; then VF_FLAGS="$VF_FLAGS --sphere-surface"; fi
          if [ "${{ inputs.show_points || 'true' }}" = "true" ]; then VF_FLAGS="$VF_FLAGS --show-points"; fi

          python scripts/viz_vector_field.py $VF_FLAGS             --viz-dir _ci_out/incoherence_vectorfield/viz_incoherence             --max-vectors "${{ inputs.max_vectors || '900' }}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incoherence_vectorfield_run${{ github.run_id }}_a${{ github.run_attempt }}
          path: _ci_out/incoherence_vectorfield/
