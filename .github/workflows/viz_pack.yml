name: Viz Pack (cinematic)

on:
  workflow_dispatch:
    inputs:
      run_dir:
        description: "Dossier de run existant. Exemple: results/run_001. Laisse vide pour lancer un run démo."
        required: false
        default: ""
      scored_csv:
        description: "Chemin vers scored.csv si externe au run_dir. Exemple: results/run_001/scored.csv"
        required: false
        default: ""
      graph_file:
        description: "Chemin vers graph_full.graphml si externe au run_dir. Exemple: results/run_001/graph_full.graphml"
        required: false
        default: ""
      explanations_file:
        description: "Chemin vers explanations.jsonl si externe au run_dir. Exemple: results/run_001/explanations.jsonl"
        required: false
        default: ""
      python_version:
        description: "Version Python"
        required: false
        default: "3.12"

  push:
    branches: ["main"]
    paths:
      - "tools/**"
      - "src/**"
      - "pyproject.toml"
      - "requirements*.txt"
      - ".github/workflows/viz_pack.yml"

jobs:
  build-viz-pack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version || '3.12' }}
          cache: "pip"

      - name: Debug versions
        run: |
          python -V
          pip -V
          python -c "import sys; print(sys.executable)"

      - name: Install package + dev deps
        run: |
          python -m pip install --upgrade pip wheel
          pip install -e ".[dev]" || pip install -e "."

      - name: Install viz deps (optional)
        run: |
          if [ -f requirements_viz.txt ]; then
            pip install -r requirements_viz.txt
          else
            echo "requirements_viz.txt absent, étape ignorée"
          fi

      - name: Ensure results dir
        run: |
          mkdir -p results

      - name: Run demo pipeline (optional)
        id: demo
        run: |
          set -e
          if [ -n "${{ inputs.run_dir }}" ]; then
            echo "run_dir fourni, pas de run démo."
            echo "RUN_DIR=${{ inputs.run_dir }}" >> $GITHUB_ENV
            exit 0
          fi

          echo "Aucun run_dir fourni, tentative de run démo."
          echo "Adapte la commande ci-dessous à ton repo si nécessaire."

          if [ -f tools/run_workflow.py ]; then
            python tools/run_workflow.py --out results/run_demo
            echo "RUN_DIR=results/run_demo" >> $GITHUB_ENV
            exit 0
          fi

          if [ -f tools/workflow.py ]; then
            python tools/workflow.py --out results/run_demo
            echo "RUN_DIR=results/run_demo" >> $GITHUB_ENV
            exit 0
          fi

          if [ -f scripts/run_sweep.py ]; then
            python scripts/run_sweep.py --out results/run_demo
            echo "RUN_DIR=results/run_demo" >> $GITHUB_ENV
            exit 0
          fi

          echo "Aucun script de run démo trouvé. Fournis un run_dir via workflow_dispatch."
          exit 1

      - name: Resolve inputs to files
        run: |
          set -e
          if [ -z "$RUN_DIR" ]; then
            echo "RUN_DIR non défini"
            exit 1
          fi

          SCORED="${{ inputs.scored_csv }}"
          GRAPH="${{ inputs.graph_file }}"
          EXPL="${{ inputs.explanations_file }}"

          if [ -z "$SCORED" ]; then
            if [ -f "$RUN_DIR/scored.csv" ]; then
              SCORED="$RUN_DIR/scored.csv"
            fi
          fi

          if [ -z "$GRAPH" ]; then
            if [ -f "$RUN_DIR/graph_full.graphml" ]; then
              GRAPH="$RUN_DIR/graph_full.graphml"
            fi
          fi

          if [ -z "$EXPL" ]; then
            if [ -f "$RUN_DIR/explanations.jsonl" ]; then
              EXPL="$RUN_DIR/explanations.jsonl"
            fi
          fi

          echo "RUN_DIR=$RUN_DIR"
          echo "SCORED=$SCORED"
          echo "GRAPH=$GRAPH"
          echo "EXPL=$EXPL"

          echo "SCORED=$SCORED" >> $GITHUB_ENV
          echo "GRAPH=$GRAPH" >> $GITHUB_ENV
          echo "EXPL=$EXPL" >> $GITHUB_ENV

      - name: Generate viz suite
        run: |
          set -e
          if [ ! -f tools/viz_a_to_h_suite.py ]; then
            echo "tools/viz_a_to_h_suite.py introuvable"
            exit 1
          fi

          CMD="python tools/viz_a_to_h_suite.py --run-dir \"$RUN_DIR\""
          if [ -n "$SCORED" ]; then
            CMD="$CMD --scored \"$SCORED\""
          fi
          if [ -n "$GRAPH" ]; then
            CMD="$CMD --graph \"$GRAPH\""
          fi
          if [ -n "$EXPL" ]; then
            CMD="$CMD --explain \"$EXPL\""
          fi

          echo "Commande: $CMD"
          eval $CMD

      - name: Zip viz output
        run: |
          set -e
          VIZ_DIR="$RUN_DIR/viz_a_to_h"
          if [ ! -d "$VIZ_DIR" ]; then
            echo "Dossier viz introuvable: $VIZ_DIR"
            find "$RUN_DIR" -maxdepth 2 -type d -print
            exit 1
          fi

          zip -r "viz_pack_${{ github.run_id }}.zip" "$VIZ_DIR"

      - name: Upload viz pack artifact
        uses: actions/upload-artifact@v4
        with:
          name: viz_pack_${{ github.run_id }}
          path: |
            viz_pack_${{ github.run_id }}.zip
            ${{ env.RUN_DIR }}/viz_a_to_h
          if-no-files-found: error
