name: hybrid_dl

on:
  workflow_dispatch:
    inputs:
      supervised_epochs:
        description: "Époques supervisées (DL)"
        required: false
        default: "12"
      contrastive_epochs:
        description: "Époques contrastives (prétrain)"
        required: false
        default: "2"
      seed:
        description: "Seed RNG"
        required: false
        default: "7"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -e ".[dev,dl]"

      - name: Train lightweight DL model (early warning)
        run: |
          mkdir -p _ci_out/model
          python -m chaostrace.cli.train_hybrid             --input test_data/sample_timeseries_1_2_drops.csv             --out _ci_out/model             --cols boat_speed,foil_height_m             --window-s 5.0             --stride-s 0.5             --horizon-s 1.0             --contrastive-epochs "${{ inputs.contrastive_epochs }}"             --supervised-epochs "${{ inputs.supervised_epochs }}"             --batch-size 64             --pos-weight 3.0             --device cpu

      - name: Run hybrid (chaos + DL)
        run: |
          mkdir -p _ci_out/hybrid_dl
          python -m chaostrace.cli.run_hybrid             --input test_data/sample_timeseries_1_2_drops.csv             --out _ci_out/hybrid_dl             --runs 30             --seed "${{ inputs.seed }}"             --enable-causal             --causal-cols boat_speed,foil_height_m             --model _ci_out/model             --device cpu             --early-window-s 2.0

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hybrid_dl_out
          path: _ci_out/
