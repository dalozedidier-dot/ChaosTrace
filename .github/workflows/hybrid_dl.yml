name: hybrid_dl

on:
  workflow_dispatch:
    inputs:
      supervised_epochs:
        description: "Époques supervisées (DL)"
        required: false
        default: "12"
      contrastive_epochs:
        description: "Époques contrastives (prétrain)"
        required: false
        default: "2"
      seed:
        description: "Seed RNG"
        required: false
        default: "7"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -e ".[dev,dl]"

      - name: Train lightweight DL model (early warning, onset-labelled)
        run: |
          mkdir -p _ci_out/model
          python -m chaostrace.cli.train_hybrid             --input test_data/sample_timeseries_1_2_drops.csv             --out _ci_out/model             --cols boat_speed,foil_height_m             --window-s 5.0             --stride-s 0.2             --horizon-s 1.5             --contrastive-epochs "${{ inputs.contrastive_epochs }}"             --supervised-epochs "${{ inputs.supervised_epochs }}"             --batch-size 64             --pos-weight 4.0             --device cpu

      - name: Run hybrid (chaos + DL)
        run: |
          mkdir -p _ci_out/hybrid_dl
          python -m chaostrace.cli.run_hybrid             --input test_data/sample_timeseries_1_2_drops.csv             --out _ci_out/hybrid_dl             --runs 30             --seed "${{ inputs.seed }}"             --enable-causal             --causal-cols boat_speed,foil_height_m             --model _ci_out/model             --device cpu             --require-dl             --early-window-s 2.0             --baseline-percentile 99.0             --threshold-min 0.38             --merge-gap-s 0.30             --min-duration-s 0.10             --pick max_ew

      - name: Assert early-warning (event F1 + lead)
        run: |
          python - <<'PY'
          import json
          import pathlib
          import sys

          p = pathlib.Path("_ci_out/hybrid_dl/metrics_hybrid.json")
          m = json.loads(p.read_text(encoding="utf-8"))

          lead_max = float(m.get("lead_s_max", 0.0))
          f1_event = float(m.get("f1_event", 0.0))
          prec_event = float(m.get("alert_event_precision", 0.0))
          rec_event = float(m.get("drop_event_recall", 0.0))
          dl_active = bool(m.get("dl_active", False))

          if not dl_active:
            print("FAIL: dl_active must be true (DL inference must run).")
            print("dl_error:", m.get("dl_error"))
            sys.exit(1)

          if lead_max <= 0.0:
            print("FAIL: lead_s_max must be > 0.0 for early warning, got", lead_max)
            sys.exit(1)

          if f1_event < 0.90:
            print("FAIL: event-level F1 must be >= 0.90, got", f1_event)
            print("event precision=", prec_event, "event recall=", rec_event)
            sys.exit(1)

          print("OK: lead_s_max=", lead_max, "f1_event=", f1_event, "prec_event=", prec_event, "rec_event=", rec_event)
          PY

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hybrid_dl_out
          path: _ci_out/
